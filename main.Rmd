---
title: "Cascade Rhône River catchment"
author: "Fabio Schneider"
date: "2025-07-11"
output:
  bookdown::html_document2:
    toc: true
    toc_depth: 3
    toc_float: true
    toc_title: true
    number_sections: true
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
# Libraries
library(sf)
library(mapview)
library(plotly)
library(ggrepel)
library(dplyr)
library(tidyverse)
library(ggpubr)
library(forestmangr)
library(zoo)
library(egg)
library(shiny)
library(rmarkdown)


```





# Cascade Model Data Input

The Cascade model is an expert-based model that uses geomorphological river characteristics to simulate bedload transport capacity.

To characterize the geomorfological properties of the river, the dataset must include information for each river reach.

## Number of Reaches

To prepare the input data for the Cascade model, the river reaches were modified to incorporate the reservoirs associated with each dam. The previous dataset contained 195 reaches, after the adjustments, we updated dataset includes a total of 67 reaches.

We adapted the number of reaches by summarizing those with similar geomorphological characteristics by integrating all reaches contained within each dam reservoir. Figure \@ref(fig:reaches) shows the integration of the reaches within the Génissiat Reservoir.


```{r reaches, echo=FALSE, fig.cap='Integration of reaches affected by dam reservoirs'}
knitr::include_graphics("img/reach.png")

```



## Elevation data smoothed

The dam reservoirs affect the river's elevation profile. To better simulate the bedload transport capacity, we smoothed the river's elevation profile. The elevation profile influenced by the dams, as well the smoothed profile are shown in Figure \@ref(fig:elev).

```{r elev, fig.cap= 'Comparision between the original and smoothed elevation profile of the Rhône River.', fig.align='center', fig.height=4, fig.width=7, fig.dpi=500, echo=FALSE, warning=FALSE}

# New data with less reaches

df_elev <- read.csv("data_rhone/Tables/elev_smooth_r67.csv")
df_elev$pk <- cumsum(df_elev$Length)/1000

read_shp <- read_sf('data_rhone/GIS_data/Rhone_network_r67.shp')
shp <- read_shp %>%
  rename(Dam = la_prise0) %>%
  arrange(reach_ID)

shp$pk <- cumsum(shp$Length)/1000
dams <- shp[!is.na(shp$Dam),]
trib <- shp[!is.na(shp$Trib),]

plt_elev <- ggplot(shp) +
  geom_line(aes(pk,el_FN, colour = 'red')) +
  geom_line(data = df_elev, aes(pk,el_FN, colour = 'green4')) +
  geom_vline(data = dams, aes(xintercept = pk, colour = 'black'), linetype = 5, lwd = 0.2) +
  geom_text(aes(pk, el_FN, label = Dam), angle = 90, vjust = -0.2, hjust = 1, size = 2, y = Inf) +
  geom_segment(data = trib, aes(x = pk, xend = pk, y = el_FN+(max(el_FN)*0.2), yend = el_FN, colour = 'blue'), arrow = arrow(length = unit(0.15, 'cm')), linewidth = 0.5) +
  geom_text(data = trib, aes(pk, el_FN+(max(el_FN)*0.2), label = Trib), angle = 90, vjust = 0, hjust = 0, size = 2, color = 'blue') +
  scale_y_continuous(name = expression('Elevation (m)'), n.breaks = 10, expand = expansion(c(0,0.05)), limits = c(0,600)) +
  scale_x_continuous(n.breaks = 10) +
  scale_colour_manual(breaks = c('red', 'green4', 'black', 'blue'),
                      values = c('red', 'green4', 'black', 'blue'),
                      labels = c('Elevation (DEM)', 'Elevation (Smoothed)', 'Dams', 'Tributaries'), name = '') +
  labs(x = 'Reach ID') +
  theme_article(base_family = "Times New Roman") +
  theme(legend.key.height = unit(0.5, 'cm'), legend.position = 'bottom', legend.spacing = unit(0, 'cm')) +
  theme(text = element_text(size = 8, colour = 'black'),
        axis.text = element_text(size = 8, colour = 'black'))
plt_elev

# ggsave(filename = 'img/elev_profile.svg', plot = plt_elev, width = 16, height = 8, units = 'cm', dpi = 300)


```

## Slope along the Rhône River

Using the new smoothed elevation profile, we extracted the slope for each river reach. The slope along the Rhône River is shown in Figure \@ref(fig:slope). 

```{r slope, fig.cap= 'Longitudinal slope profile of the Rhône River derived from the smoothed elevation data.', fig.align='center', fig.height=4, fig.width=7, fig.dpi=500, echo=FALSE, warning=FALSE}


# New data with less reaches

shp_var <- read_shp %>%
  rename(Dam = la_prise0) %>%
  arrange(reach_ID) 

df_ele_smooth <- df_elev %>%
  select(reach_ID,el_FN,el_TN,Slope)

shp_smooted <- shp_var %>%
  select(reach_ID,Length,FromN,ToN,Dam,Trib) %>%
  left_join(df_ele_smooth, by = "reach_ID")


shp_smooted$pk <- cumsum(shp_smooted$Length)/1000
dams <- shp_smooted[!is.na(shp_smooted$Dam),]
trib <- shp_smooted[!is.na(shp_smooted$Trib),]

plt_slope <- ggplot(shp_smooted) +
  geom_line(aes(pk, Slope, colour = "orange")) +
  geom_vline(data = dams, aes(xintercept = pk, colour = 'black'), linetype = 5, lwd = 0.2) +
  geom_text(aes(pk, el_FN, label = Dam), angle = 90, vjust = -0.2, hjust = 1, size = 2, y = Inf) +
  geom_segment(data = trib, aes(x = pk, xend = pk, y = Slope+(max(shp_smooted$Slope)*0.2), yend = Slope, colour = 'blue'), arrow = arrow(length = unit(0.15, 'cm')), linewidth = 0.5) +
  geom_text(data = trib, aes(pk, Slope+(max(shp_smooted$Slope)*0.2), label = Trib), angle = 90, vjust = 0, hjust = 0, size = 2, color = 'blue') +
  scale_y_continuous(name = expression('Elevation (m)'), n.breaks = 10, expand = expansion(c(0,0.05)), limits = c(0,0.015)) +
  scale_x_continuous(n.breaks = 10) +
  scale_colour_manual(breaks = c("orange", 'black', 'blue'),
                      values = c("orange", 'black', 'blue'),
                      labels = c("Slope (m/m)", 'Dams', 'Tributaries'), name = '') +
  labs(x = 'Reach ID') +
  theme_article(base_family = "Times New Roman") +
  theme(legend.key.height = unit(0.5, 'cm'), legend.position = 'bottom', legend.spacing = unit(0, 'cm')) +
  theme(text = element_text(size = 8, colour = 'black'),
        axis.text = element_text(size = 8, colour = 'black')) 
plt_slope

# ggsave(filename = 'img/slope_profile.svg', plot = plt_slope, width = 16, height = 8, units = 'cm', dpi = 300)

```


## GSD along the Rhône River


```{r, include=FALSE}

# GSD points

## GSD data Parrot et al (2021)
df_gsd_parrot <- read.csv("data_rhone/GIS_data/gsd/gsd_parrot.csv")
df_gsd_parrot <- df_gsd_parrot[,c("reach_ID", "D16mm", "D50mm", "D84mm")]

df_gsd <- aggregate(.~reach_ID, data = df_gsd_parrot, FUN = max) %>% 
  rename(D16 = D16mm, D50 = D50mm, D84 = D84mm) %>% na.omit()
df_gsd[,-1] <- df_gsd[,-1]/1000


reach_ID <- c(1:67)
df_gsd_67 <- data.frame(reach_ID = reach_ID)
df_gsd67 <- df_gsd_67 %>% left_join(df_gsd, by = "reach_ID")

shp_gsd_noapprox <- shp_smooted %>% left_join(df_gsd67, by = "reach_ID")

shp_gsd_approx <- shp_gsd_noapprox
shp_gsd_approx$D16 <- na.approx(shp_gsd_approx$D16, na.rm = F)
shp_gsd_approx$D16 <- na.locf(shp_gsd_approx$D16, fromLast = T)

shp_gsd_approx$D50 <- na.approx(shp_gsd_approx$D50, na.rm = F)
shp_gsd_approx$D50 <- na.locf(shp_gsd_approx$D50, fromLast = T)

shp_gsd_approx$D84 <- na.approx(shp_gsd_approx$D84, na.rm = F)
shp_gsd_approx$D84 <- na.locf(shp_gsd_approx$D84, fromLast = T)


dams <- shp_gsd_approx[!is.na(shp$Dam),]
trib <- shp_gsd_approx[!is.na(shp$Trib),]

write_sf(shp_gsd_approx, "data_rhone/GIS_data/temp/shp_net_temp.gpkg")

```


```{r, include=FALSE}

# piloting the GSD graphics

# Elevation

plt_elev_gsd <- ggplot(shp_gsd_approx) +
  geom_line(aes(reach_ID, el_FN, colour = 'coral4'), lwd = 0.5) +
  geom_point(data = dams, aes(reach_ID, el_FN, colour = 'black'), shape = 18, size = 2) +
  scale_y_continuous(name = 'Elevation (m)', limits = c(0,600), n.breaks = 5, expand = expansion(mult = c(0,0.2))) +
  scale_x_continuous(n.breaks = 10) +
  geom_text(aes(reach_ID, el_FN, label = Dam), angle = 90, vjust = -0.2, hjust = 1, size = 2, y = Inf) +
  geom_segment(data = trib, aes(x = reach_ID, xend = reach_ID, y = el_FN+(max(shp_gsd_approx$el_FN)*0.2), yend = el_FN, colour = 'blue'),
               arrow = arrow(length = unit(0.15, 'cm')), linewidth = 0.5) +
  geom_text(data = trib, aes(reach_ID, el_FN+(max(shp_gsd_approx$el_FN)*0.2), label = Trib), angle = 90, vjust = -0.2, hjust = 0, size = 2, color = 'blue') +
  geom_vline(data = dams, aes(xintercept = reach_ID, colour = 'black'), linetype = 5, lwd = 0.2) +
  scale_fill_manual(breaks = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                    values = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                    labels = c('GSD estimated', 'GSD measured', 'Elevation', 'Dams', 'Tributaries'), name = '') +
  scale_colour_manual(breaks = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                      values = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                      labels = c('GSD estimated', 'GSD measured', 'Elevation', 'Dams', 'Tributaries'), name = '') +
  labs(x = 'Reach ID') +
  theme_article(base_family = "Times New Roman") +
  geom_hline(yintercept = 0, lwd = 0.2) +
  theme(legend.key.height = unit(0.5, 'cm'), legend.position = 'none', legend.spacing = unit(0, 'cm')) +
  theme(text = element_text(size = 8, colour = 'black'),
        axis.text = element_text(size = 8, colour = 'black'),
        axis.text.x = element_blank(), axis.title.x = element_blank()) 
plt_elev_gsd


# D16

p_D16 <- ggplot(shp_gsd_approx) +
  geom_col(aes(reach_ID, D16, fill = 'brown1'), color = 1, lwd = 0.1) +
  geom_col(data = df_gsd, aes(reach_ID, D16, fill = 'gray10'), color = 1, lwd = 0.1) +
  scale_y_continuous(name = expression('D16 (m)'), n.breaks = 5, expand = expansion(mult = c(0,0.2))) +
  scale_x_continuous(n.breaks = 10) +
  geom_segment(data = trib, aes(x = reach_ID, xend = reach_ID, y = D16+(max(df_gsd$D16)*0.2),
                                yend = D16, colour = 'blue'), arrow = arrow(length = unit(0.15, 'cm')), linewidth = 0.5) +
  geom_text(data = trib, aes(reach_ID, D16+(max(df_gsd$D16)*0.2),
                             label = Trib), angle = 90, vjust = -0.2, hjust = 0, size = 2, color = 'blue') +
  geom_vline(data = dams, aes(xintercept = reach_ID, colour = 'black'), linetype = 5, lwd = 0.2) +
  scale_fill_manual(breaks = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                    values = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                    labels = c('GSD estimated', 'GSD measured', 'Elevation', 'Dams', 'Tributaries'), name = '') +
  scale_colour_manual(breaks = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                      values = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                      labels = c('GSD estimated', 'GSD measured', 'Elevation', 'Dams', 'Tributaries'), name = '') +
  labs(x = 'Reach ID') +
  theme_article(base_family = "Times New Roman") +
  geom_hline(yintercept = 0, lwd = 0.2) +
  theme(legend.key.height = unit(0.5, 'cm'), legend.position = 'none', legend.spacing = unit(0, 'cm')) +
  theme(text = element_text(size = 8, colour = 'black'),
        axis.text = element_text(size = 8, colour = 'black'),
        axis.text.x = element_blank(), axis.title.x = element_blank()) 
p_D16


# D50

p_D50 <- ggplot(shp_gsd_approx) +
  geom_col(aes(reach_ID, D50, fill = 'brown1'), color = 1, lwd = 0.1) +
  geom_col(data = df_gsd, aes(reach_ID, D50, fill = 'gray10'), color = 1, lwd = 0.1) +
  scale_y_continuous(name = expression('D50 (m)'), n.breaks = 5, expand = expansion(mult = c(0,0.2))) +
  scale_x_continuous(n.breaks = 10) +
  geom_segment(data = trib, aes(x = reach_ID, xend = reach_ID, y = D50+(max(df_gsd$D50)*0.2),
                                yend = D50, colour = 'blue'), arrow = arrow(length = unit(0.15, 'cm')), linewidth = 0.5) +
  geom_text(data = trib, aes(reach_ID, D50+(max(df_gsd$D50)*0.2),
                             label = Trib), angle = 90, vjust = -0.2, hjust = 0, size = 2, color = 'blue') +
  geom_vline(data = dams, aes(xintercept = reach_ID, colour = 'black'), linetype = 5, lwd = 0.2) +
  scale_fill_manual(breaks = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                    values = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                    labels = c('GSD estimated', 'GSD measured', 'Elevation', 'Dams', 'Tributaries'), name = '') +
  scale_colour_manual(breaks = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                      values = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                      labels = c('GSD estimated', 'GSD measured', 'Elevation', 'Dams', 'Tributaries'), name = '') +
  labs(x = 'Reach ID') +
  theme_article(base_family = "Times New Roman") +
  geom_hline(yintercept = 0, lwd = 0.2) +
  theme(legend.key.height = unit(0.5, 'cm'), legend.position = 'none', legend.spacing = unit(0, 'cm')) +
  theme(text = element_text(size = 8, colour = 'black'),
        axis.text = element_text(size = 8, colour = 'black'),
        axis.text.x = element_blank(), axis.title.x = element_blank()) 

p_D50

# D84

p_D84 <- ggplot(shp_gsd_approx) +
  geom_col(aes(reach_ID, D84, fill = 'brown1'), color = 1, lwd = 0.1) +
  geom_col(data = df_gsd, aes(reach_ID, D84, fill = 'gray10'), color = 1, lwd = 0.1) +
  scale_y_continuous(name = expression('D84 (m)'), n.breaks = 5, expand = expansion(mult = c(0,0.2))) +
  scale_x_continuous(n.breaks = 10) +
  geom_segment(data = trib, aes(x = reach_ID, xend = reach_ID, y = D84+(max(df_gsd$D84)*0.2),
                                yend = D84, colour = 'blue'), arrow = arrow(length = unit(0.15, 'cm')), linewidth = 0.5) +
  geom_text(data = trib, aes(reach_ID, D84+(max(df_gsd$D84)*0.2),
                             label = Trib), angle = 90, vjust = -0.2, hjust = 0, size = 2, color = 'blue') +
  geom_vline(data = dams, aes(xintercept = reach_ID, colour = 'black'), linetype = 5, lwd = 0.2) +
  scale_fill_manual(breaks = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                    values = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                    labels = c('GSD estimated', 'GSD measured', 'Elevation', 'Dams', 'Tributaries'), name = '') +
  scale_colour_manual(breaks = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                      values = c('brown1', 'gray10', 'coral4', 'black', 'blue'),
                      labels = c('GSD estimated', 'GSD measured', 'Elevation', 'Dams', 'Tributaries'), name = '') +
  labs(x = 'Reach ID') +
  theme_article(base_family = "Times New Roman") +
  geom_hline(yintercept = 0, lwd = 0.2) +
  theme(legend.key.height = unit(0.5, 'cm'), legend.position = 'bottom', legend.spacing = unit(0, 'cm')) +
  theme(text = element_text(size = 8, colour = 'black'),
        axis.text = element_text(size = 8, colour = 'black')) 

p_D84


```

The grain size distribution (GSD) was obtained from the data available in the report by Parrot et al. (2021), Annexe 17: Données statistiques (D16, D50, D84, D90) des prélèvements réalisés par dragage avec la CNR dans le chenal du Rhône (campagnes 2012-13). The Figure \@ref(fig:gsd) shows the data measured data (black bars) and the linearly estimated values (brown bars) for each river reach along the Rhône River.

For the reaches with more than one GSD value, the highest value observed for each GSD class was used. For the reaches without GSD data, values were linearly interpolated from neighboring reaches with available data. The Figure 8 shows the longitudinal GSD along the Rhône River.

```{r gsd, fig.cap= 'Grain Size Distribution (GSD) measured and estimated of the bed material along the Rhône River for each river reach.', fig.align='center', fig.height=8, fig.width=7, fig.dpi=500, echo=FALSE, warning=FALSE}
p_GSD <- ggarrange(plots = list(plt_elev_gsd, p_D16, p_D50, p_D84), nrow = 4, ncol = 1)

# ggsave(filename = 'img/GSD.svg', plot = p_GSD, width = 16, height = 18, units = 'cm', dpi = 300)
```

```{r, echo=FALSE, warning=FALSE}

library(sf)
library(leaflet)
library(dplyr)
library(shiny)

# ⇢ Ajuste o caminho se o .gpkg estiver noutro lugar
shp <- st_read("data_rhone/GIS_data/temp/shp_net_temp.gpkg", quiet = TRUE)

# Garante lat/lon (WGS 84)
if (st_crs(shp)$epsg != 4326) shp <- st_transform(shp, 4326)

# Colunas disponíveis (numéricas ou categóricas)
cols_disp <- shp %>%
  st_drop_geometry() %>%
  select(where(~ is.numeric(.x) || is.character(.x) || is.factor(.x))) %>%
  names()

selectInput("var_sel",
            label   = "Coluna:",
            choices = cols_disp,
            selected = cols_disp[1])


renderLeaflet({
  req(input$var_sel)

  vals_raw <- shp[[input$var_sel]]

  # Detecta tipo da variável
  is_num <- suppressWarnings(!any(is.na(as.numeric(as.character(vals_raw)))))

  if (is_num) {
    vals <- as.numeric(as.character(vals_raw))
    pal <- colorNumeric("viridis", domain = vals, na.color = "transparent")
    wgt <- scales::rescale(vals, to = c(1, 5))
    tipo_legenda <- "gradiente"
  } else {
    vals <- as.factor(vals_raw)
    pal <- colorFactor("Set3", domain = vals, na.color = "transparent")
    wgt <- 2
    tipo_legenda <- "categorias"
  }

  leaflet(shp) %>%
    addProviderTiles("CartoDB.Positron") %>%
    addPolylines(
      color = ~pal(vals),
      weight = wgt,
      opacity = 0.9,
      popup = ~paste(input$var_sel, ":", vals)
    ) %>%
    addLegend("bottomright",
              pal = pal,
              values = vals,
              title = paste("Legenda:", input$var_sel, "-", tipo_legenda))
})


```










